{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Shareholders{% endblock %}

{% block extra_css %}
<style>
    .summary-card {
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    .summary-card:hover {
        transform: translateY(-5px);
    }
    .card-1 { background: linear-gradient(45deg, #4e73df, #224abe); }
    .card-2 { background: linear-gradient(45deg, #1cc88a, #13855c); }
    .card-3 { background: linear-gradient(45deg, #36b9cc, #258391); }
    .card-4 { background: linear-gradient(45deg, #f6c23e, #dda20a); }
    .summary-icon {
        font-size: 2.5rem;
        opacity: 0.8;
    }
    .table-responsive {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        padding: 20px;
    }
    .search-box {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .action-buttons .btn {
        margin-right: 8px;
        margin-bottom: 8px;
    }
    .shareholder-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        object-fit: cover;
    }
    .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .status-active { background-color: #d1e7dd; color: #0f5132; }
    .status-inactive { background-color: #f8d7da; color: #842029; }
    .status-pending { background-color: #fff3cd; color: #664d03; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Shareholders</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addShareholderModal">
            <i class="fas fa-user-plus me-2"></i>Add Shareholder
        </button>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="summary-card card-1">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1">Total Shareholders</h6>
                        <h3 class="mb-0">{{ shareholders|length }}</h3>
                    </div>
                    <i class="fas fa-users summary-icon"></i>
                </div>
                <div class="mt-3 text-sm">
                    <span class="me-2"><i class="fas fa-arrow-up"></i> 12.5%</span>
                    <span>Since last quarter</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card card-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1">Active Shareholders</h6>
                        <h3 class="mb-0">{% widthratio shareholders|length 1 0.85 %}</h3>
                    </div>
                    <i class="fas fa-user-check summary-icon"></i>
                </div>
                <div class="mt-3 text-sm">
                    <span class="me-2"><i class="fas fa-arrow-up"></i> 8.2%</span>
                    <span>Since last quarter</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card card-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1">Total Shares</h6>
                        <h3 class="mb-0">1,250,000</h3>
                    </div>
                    <i class="fas fa-chart-pie summary-icon"></i>
                </div>
                <div class="mt-3 text-sm">
                    <span class="me-2"><i class="fas fa-arrow-up"></i> 5.3%</span>
                    <span>Since last quarter</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="summary-card card-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1">Avg. Shares/Investor</h6>
                        <h3 class="mb-0">{{ "5000"|floatformat:0 }}</h3>
                    </div>
                    <i class="fas fa-chart-line summary-icon"></i>
                </div>
                <div class="mt-3 text-sm">
                    <span class="me-2"><i class="fas fa-arrow-up"></i> 3.1%</span>
                    <span>Since last quarter</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="search-box">
        <div class="row">
            <div class="col-md-8">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search shareholders by name, ID, or contact..." id="shareholderSearch">
                    <button class="btn btn-outline-secondary" type="button" id="searchButton">Search</button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-filter"></i></span>
                    <select class="form-select" id="statusFilter">
                        <option value="" selected>All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending Approval</option>
                    </select>
                    <button class="btn btn-outline-secondary" type="button" id="filterButton">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shareholders Table -->
    <div class="table-responsive">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Shareholder Directory</h5>
            <div class="action-buttons">
                <button class="btn btn-sm btn-outline-secondary" id="exportButton">
                    <i class="fas fa-download me-1"></i> Export
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="printButton">
                    <i class="fas fa-print me-1"></i> Print
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="shareholdersTable">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Shareholder</th>
                        <th>ID/Passport</th>
                        <th>Shares</th>
                        <th>Ownership %</th>
                        <th>Contact</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for shareholder in shareholders %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="{% static 'dashboard/ipi_logo.png' %}" alt="Shareholder" class="shareholder-avatar">
                                <div>
                                    <div class="fw-bold">{{ shareholder.full_name }}</div>
                                    <small class="text-muted">{{ shareholder.company.name|default:"Individual" }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ shareholder.id_number|default:"N/A" }}</td>
                        <td>{{ shareholder.total_shares|default:0|floatformat:0 }}</td>
                        <td>{% widthratio shareholder.total_shares 1250000 100 %}%</td>
                        <td>
                            <div class="text-nowrap">
                                <div><i class="fas fa-envelope me-1 text-muted"></i> {{ shareholder.email|default:"N/A" }}</div>
                                <div><i class="fas fa-phone me-1 text-muted"></i> {{ shareholder.phone|default:"N/A" }}</div>
                            </div>
                        </td>
                        <td>
                            {% if shareholder.is_active %}
                                <span class="status-badge status-active">Active</span>
                            {% else %}
                                <span class="status-badge status-inactive">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" title="View Details" 
                                        onclick="viewShareholder({{ shareholder.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" title="Edit"
                                        onclick="editShareholder({{ shareholder.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" title="Deactivate"
                                        onclick="confirmDeactivate({{ shareholder.id }})">
                                    <i class="fas fa-user-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-users fa-2x mb-2"></i>
                                <p class="mb-0">No shareholders found. Click 'Add Shareholder' to get started.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if shareholders.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if shareholders.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ shareholders.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&laquo;</span>
                </li>
                {% endif %}

                {% for i in shareholders.paginator.page_range %}
                    {% if shareholders.number == i %}
                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                    {% else %}
                    <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                    {% endif %}
                {% endfor %}

                {% if shareholders.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ shareholders.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link" aria-hidden="true">&raquo;</span>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Add Shareholder Modal -->
<div class="modal fade" id="addShareholderModal" tabindex="-1" aria-labelledby="addShareholderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addShareholderModalLabel">Add New Shareholder</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addShareholderForm" method="post" action="{% url 'dashboard:shareholders' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="fullName" class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="fullName" name="full_name" required>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label for="idNumber" class="form-label mb-0">ID Number</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="useCustomId" name="use_custom_id">
                                    <label class="form-check-label" for="useCustomId" style="font-size: 0.8rem;">Use custom ID</label>
                                </div>
                            </div>
                            <input type="text" class="form-control" id="idNumber" name="id_number" 
                                   value="{{ auto_generated_id }}" readonly>
                            <small class="form-text text-muted">Auto-generated ID. Check "Use custom ID" to enter manually.</small>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        <div class="col-md-6">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" name="phone_number">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="company" class="form-label">Company (if applicable)</label>
                            <select class="form-select" id="gender" name="gender">
                                <option value="">Select Gender</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                                <option value="P">Prefer not to say</option>
                                <option value="">Select Company</option>
                                <option value="1">Company A</option>
                                <option value="2">Company B</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="initialShares" class="form-label">Initial Shares</label>
                            <input type="date" class="form-control" id="dateOfBirth" name="date_of_birth">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <textarea class="form-control" id="address" name="address" rows="2" placeholder="Enter full address"></textarea>
                    </div>
                    
                    <div class="modal-footer mt-4">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Shareholder</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle custom ID field
        const useCustomId = document.getElementById('useCustomId');
        const idNumberField = document.getElementById('idNumber');
        const autoGeneratedId = "{{ auto_generated_id }}";

        useCustomId.addEventListener('change', function() {
            if (this.checked) {
                idNumberField.readOnly = false;
                idNumberField.value = '';
                idNumberField.placeholder = 'Enter custom ID';
                idNumberField.required = true;
            } else {
                idNumberField.readOnly = true;
                idNumberField.value = autoGeneratedId;
                idNumberField.required = false;
            }
        });

        // Initialize tooltips
        // Tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Search functionality
        document.getElementById('searchButton').addEventListener('click', function() {
            const searchTerm = document.getElementById('shareholderSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#shareholdersTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Filter by status
        document.getElementById('filterButton').addEventListener('click', function() {
            const status = document.getElementById('statusFilter').value;
            const rows = document.querySelectorAll('#shareholdersTable tbody tr');
            
            rows.forEach(row => {
                if (status === '') {
                    row.style.display = '';
                    return;
                }
                
                const statusCell = row.querySelector('td:nth-child(7) .status-badge');
                if (statusCell) {
                    const rowStatus = statusCell.textContent.trim().toLowerCase();
                    row.style.display = rowStatus.includes(status) ? '' : 'none';
                }
            });
        });

        // Export functionality
        document.getElementById('exportButton').addEventListener('click', function() {
            // Implement export to CSV/Excel
            alert('Export functionality will be implemented here');
        });

        // Print functionality
        document.getElementById('printButton').addEventListener('click', function() {
            window.print();
        });

        // Save shareholder
        document.getElementById('saveShareholder').addEventListener('click', function() {
            // Implement save functionality
            alert('Save functionality will be implemented here');
        });
    });

    // View shareholder details
    function viewShareholder(id) {
        // Implement view details functionality
        alert('Viewing shareholder with ID: ' + id);
    }

    // Edit shareholder
    function editShareholder(id) {
        // Implement edit functionality
        alert('Editing shareholder with ID: ' + id);
    }

    // Confirm deactivation
    function confirmDeactivate(id) {
        if (confirm('Are you sure you want to deactivate this shareholder? This action cannot be undone.')) {
            // Implement deactivation
            alert('Deactivating shareholder with ID: ' + id);
        }
    }
</script>
{% endblock %}
